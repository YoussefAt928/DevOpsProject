name: Docker Build & Deploy to TEST

on:
  push:
    branches:
      - dev

jobs:
  deploy-test:
    runs-on: self-hosted

    steps:
      - name: Deploy on TEST server
        run: |
          ssh root@192.168.1.144 << 'EOF'
            set -e

            echo "ðŸš€ Deploying DEV to TEST"

            cd /var/www/current

            git fetch origin
            git checkout dev
            git reset --hard origin/dev

            IMAGE_TAG=dev-$(git rev-parse --short HEAD)

            podman stop laravel_app || true
            podman rm laravel_app || true

            podman build -t laravel-app:${IMAGE_TAG} .

            podman run -d \
              --name laravel_app \
              --env-file /var/www/current/.env \
              -p 8080:80 \
              laravel-app:${IMAGE_TAG}

            echo "âœ… TEST deployment completed"
          EOF
